<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Basic Page Needs
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>Defold App Manifest generator</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- FONT
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <!-- CSS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">

    <!-- Favicon
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="images/favicon.png">

    <style>
        input { margin-right: 1em; }
        textarea
        {
           font-family: monospace;
        }

        .osicon {
            margin-left: 5px;
        }
    </style>

    <!-- https://www.w3schools.com/css/css_tooltip.asp -->
    <style>
        /* Tooltip container */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        /* Tooltip text */
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #333;
            color: #fff;
            text-align: center;
            padding: 10px 20px;
            border-radius: 6px;

            /* Position the tooltip text - see examples below! */
            position: absolute;
            z-index: 1;
        }

        /* Show the tooltip text when you mouse over the tooltip container */
        .tooltip:hover .tooltiptext {
            visibility: visible;
        }
    </style>

    <script>
        // https://stackoverflow.com/a/4673436
        if (!String.prototype.format) {
            String.prototype.format = function() {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function(match, number) {
                    return typeof args[number] != 'undefined' ? args[number] : match;
                });
            };
        }

        var platforms = [ "x86_64-osx", "x86_64-linux", "js-web", "x86-win32", "x86_64-win32", "armv7-android", "armv7-ios", "arm64-ios" ]

        function is_windows(platform) {
            return platform == "x86-win32" || platform == "x86_64-win32"
        }

        function platformify_excluded_lib(platform, name) {
            return is_windows(platform) ? ('"' + "lib" + name + '"') : ('"' + name + '"');
        }

        function platformify_lib(platform, name) {
            return is_windows(platform) ? ('"' + "lib" + name + '.lib"') : ('"' + name + '"');
        }

        function push_excluded_libs(platforms, exclusions, names) {
            names.forEach(function(name) {
                platforms.forEach(function(platform) {
                    exclusions[platform].excludeLibs.push(platformify_excluded_lib(platform, name));
                });
            });
        }
        function push_excluded_symbols(platforms, exclusions, names) {
            names.forEach(function(name) {
                platforms.forEach(function(platform) {
                    exclusions[platform].excludeSymbols.push('"' + name + '"');
                });
            });
        }
        function push_libs(platforms, exclusions, names) {
            names.forEach(function(name) {
                platforms.forEach(function(platform) {
                    exclusions[platform].libs.push(platformify_lib(platform, name));
                });
            });
        }
        function push_link_flags(platforms, exclusions, names) {
            names.forEach(function(name) {
                platforms.forEach(function(platform) {
                    exclusions[platform].linkFlags.push('"' + name + '"');
                })
            });
        }
        function unshift_libs(exclusions, names) {
            names.forEach(function(name) {
                platforms.forEach(function(platform) {
                    exclusions[platform].libs.unshift(platformify_lib(platform, name));
                });
            });
        }

        function update_manifest() {
            var settings = {
                physics: document.getElementById("physics").checked,
                record: document.getElementById("record").checked,
                profiler: document.getElementById("profiler").checked,
                facebook: document.getElementById("facebook").checked,
                release: document.getElementById("release").checked,
                sound: document.getElementById("sound").checked,
                graphics: document.getElementById("graphics").checked,
                headless: document.getElementById("headless").checked,
                input: document.getElementById("input").checked,
                use_clang: document.getElementById("use_clang").checked,
                hide_console: document.getElementById("hide_console").checked,
            }

            var excluded
            var exclusions = {
                settings: [],
                platforms: [],
            };
            platforms.forEach(function(platform) {
                exclusions.platforms[platform] = {
                    id: platform,
                    excludeLibs: [],
                    excludeSymbols: [],
                    libs: [],
                    linkFlags: [],
                };
            });

            if (settings.physics) {
                exclusions.settings.push("Physics");
                push_excluded_libs(platforms, exclusions.platforms, ["BulletDynamics", "BulletCollision", "LinearMath", "Box2D", "physics" ]);
                push_libs(platforms, exclusions.platforms, [ "physics_null" ]);
            }
            if (settings.record || settings.headless) {
                exclusions.settings.push("Record");
                push_excluded_libs(platforms, exclusions.platforms, [ "record", "vpx" ]);
                push_libs(desktop_platforms, exclusions.platforms, [ "record_null" ]);
            }
            if (settings.profiler) {
                exclusions.settings.push("Profiler");
                push_excluded_libs(platforms, exclusions.platforms, [ "profilerext" ]);
                push_excluded_symbols(platforms, exclusions.platforms, [ "ProfilerExt" ]);
            }
            if (settings.facebook) {
                exclusions.settings.push("Facebook");
                push_excluded_symbols(platforms, exclusions.platforms, [ "FacebookExt" ]);
            }
            if (settings.sound || settings.headless) {
                exclusions.settings.push("Sound");
                push_excluded_libs(platforms, exclusions.platforms, ["sound", "tremolo"]);
                push_excluded_symbols(platforms, exclusions.platforms, ["DefaultSoundDevice", "AudioDecoderWav", "AudioDecoderStbVorbis", "AudioDecoderTremolo"]);
                push_libs(platforms, exclusions.platforms, ["sound_null"]);
            }
            if (settings.graphics || settings.headless) {
                exclusions.settings.push("Graphics");
                push_excluded_libs(platforms, exclusions.platforms, ["graphics"]);
                push_libs(platforms, exclusions.platforms, ["graphics_null"]);
            }
            if (settings.input || settings.headless) {
                exclusions.settings.push("Input");
                push_excluded_libs(platforms, exclusions.platforms, ["hid"]);
                push_libs(platforms, exclusions.platforms, ["hid_null"]);
            }
            if (settings.release) {
                exclusions.settings.push("Release");
                push_excluded_libs(platforms, exclusions.platforms, ["engine"]);
                unshift_libs(exclusions.platforms, ["engine_release"]);
            }
            else {
                exclusions.settings.push("Debug");
                push_excluded_libs(platforms, exclusions.platforms, ["engine"]);
                unshift_libs(exclusions.platforms, ["engine"]);
            }
            if (settings.use_clang) {
                exclusions.settings.push("Clang");
            }
            if (settings.hide_console) {
                exclusions.settings.push("HideConsole");
                push_link_flags(["x86-win32", "x86_64-win32"], exclusions.platforms, [settings.use_clang ? "-Wl,/subsystem:windows" : "/subsystem:windows"])
            }

            var manifest = "# App manifest generated {0}\n".format(new Date());
            manifest += "# Settings: {0}\n".format(exclusions.settings.join());
            manifest += "platforms:\n";
            platforms.forEach(function(platform) {
                manifest += "    {0}:\n".format(platform);
                manifest += "        context:\n";
                manifest += "            excludeLibs: [{0}]\n".format(exclusions.platforms[platform].excludeLibs.join());
                manifest += "            excludeSymbols: [{0}]\n".format(exclusions.platforms[platform].excludeSymbols.join());
                manifest += "            libs: [{0}]\n".format(exclusions.platforms[platform].libs.join());
                manifest += "            linkFlags: [{0}]\n".format(exclusions.platforms[platform].linkFlags.join());
                if (is_windows(platform) && settings.use_clang)  {
                    manifest += "            use-clang: true\n";
                }
                manifest += "\n";
            });

            document.getElementById("manifest").value = manifest;
        }
    </script>

    <script src="js/toast.min.js"></script>
    <script>
        // https://github.com/mlcheng/js-toast/
        function toast(text) {
            var options = {
                style: {
                    main: {
                        background: "#333",
                        color: "#FFF",
                        'box-shadow': '0 0 50px rgba(0, 0, 0, .7)'
                    }
                },
                settings: {
                    duration: 1500
                }
            };
            iqwerty.toast.Toast(text, options);
        }
    </script>

    <script>
        function copy_to_clipboard() {
            document.getElementById("manifest").select();
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'successful' : 'unsuccessful';
                console.log('Copying text command was ' + msg);
                if (successful) {
                    toast('Copied!');
                }
                else {
                    toast('Oops, unable to copy');
                }
            } catch (err) {
                console.log('Oops, unable to copy');
                toast('Oops, unable to copy');
            }
            // deselect
            if (document.selection) {
                document.selection.empty();
            }
            else if ( window.getSelection ) {
                window.getSelection().removeAllRanges();
            }
        }
    </script>

    <script>
        // https://stackoverflow.com/a/18197341/1266551
        function download_as_file() {
            var text = document.getElementById("manifest").value;
            var filename = "generated.appmanifest";

            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    </script>
</head>

<body onload="update_manifest();">

    <!-- Primary Page Layout
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div class="container" style='position:relative;'>
        <div class="row">
            <div style="margin-top: 5%">
                <h3>Defold App Manifest generator</h3>
                <p>This tool generates a Defold App Manifest that can be used to build a custom engine.</p>
                <p>Download the generated file or copy and paste into a file with the <span style="font-family: monospace;">.appmanifest</span> extension. Save the file to a location in your project and reference it in the <a href="https://www.defold.com/manuals/project-settings/#_native_extension" target="_blank">App Manifest field of the Native Extension section</a> in game.project.</p>
            </div>
        </div>
        <div class="row">
            <div class="three columns">
                <form>
                    <h4>Settings</h4>
                    <label><input id="physics" type="checkbox" onchange="update_manifest()"/>Exclude Physics
                        <div class="tooltip"><img src="images/question-mark_16.png" class="tooltip"/>
                            <span class="tooltiptext">Remove both Box2D and Bullet</span>
                        </div>
                    </label>
                    <label><input id="record" type="checkbox" onchange="update_manifest()"/>Exclude Record
                        <div class="tooltip">
                            <img src="images/question-mark_16.png" class="tooltip"/>
                            <span class="tooltiptext">Remove the video recording capabilities</br>
                                <img src="images/windows_w.png" class="osicon"/>
                                <img src="images/osx_w.png" class="osicon"/>
                                <img src="images/linux_w.png" class="osicon"/>
                            </span>
                        </div>
                    </label>
                    <label><input id="profiler" type="checkbox" onchange="update_manifest()"/>Exclude Profiler
                        <div class="tooltip"><img src="images/question-mark_16.png" class="tooltip"/>
                            <span class="tooltiptext">Remove the on-screen and web profiler</span>
                        </div>
                    </label>
                    <label><input id="facebook" type="checkbox" onchange="update_manifest()"/>Exclude Facebook
                        <div class="tooltip"><img src="images/question-mark_16.png" class="tooltip"/>
                            <span class="tooltiptext">Remove the Facebook SDK</br>
                                <img src="images/ios_w.png" class="osicon"/>
                                <img src="images/android_w.png" class="osicon"/>
                                <img src="images/html5_w.png" class="osicon"/>
                            </span>
                        </div>
                    </label>
                    <label><input id="sound" type="checkbox" onchange="update_manifest()"/>Exclude Sound
                    </label>
                    <label><input id="graphics" type="checkbox" onchange="update_manifest()"/>Exclude Graphics
                    </label>
                    <label><input id="input" type="checkbox" onchange="update_manifest()"/>Exclude Input
                    </label>
                    <label><input id="release" type="checkbox" onchange="update_manifest()"/>Release
                        <div class="tooltip"><img src="images/question-mark_16.png" class="tooltip"/>
                            <span class="tooltiptext">Force a release build (no logs to console and no reverse hash lookup)</span>
                        </div>
                    </label>
                    <label><input id="headless" type="checkbox" onchange="update_manifest()"/>Make headless
                        <div class="tooltip"><img src="images/question-mark_16.png" class="tooltip"/>
                            <span class="tooltiptext">Create a headless engine version (no sound, no graphics and no input)</span>
                        </div>
                    </label>
                    <label><input id="use_clang" type="checkbox" onchange="update_manifest()" checked/>Use Clang
                        <div class="tooltip"><img src="images/question-mark_16.png" class="tooltip"/>
                            <span class="tooltiptext">Use clang when building Windows versions of the engine. This will reduce build times significantly when using native extensions. Uncheck if you have problems building extensions for Windows. Read more <a href="https://forum.defold.com/t/native-extensions-win32-clang/28084/2" target="_blank">here</a>.</br>
                            <img src="images/windows_w.png" class="osicon"/></span>
                        </div>
                    </label>
                    <label><input id="hide_console" type="checkbox" onchange="update_manifest()"/>Hide Console
                        <div class="tooltip"><img src="images/question-mark_16.png" class="tooltip"/>
                            <span class="tooltiptext">Hide the console window when the app is launched.</br>
                            <img src="images/windows_w.png" class="osicon"/</span>
                        </div>
                    </label>
                </form>
            </div>
            <div class="nine columns">
                <h4>Manifest</h4>
                <textarea id="manifest" rows="20" cols="80" readonly style="height: auto;">Generated app manifest goes here</textarea>
                <button style="vertical-align:top;" onclick="download_as_file()">Download</button>
                <button style="vertical-align:top;" onclick="copy_to_clipboard()">Copy to clipboard</button>
            </div>
        </div>
        <div class="row">
            <div style="margin-top: 15%">
                <p>
                    Site template by <a href="http://getskeleton.com/" target="_blank">Skeleton</a> - Icons by <a href="https://www.flaticon.com/" target="_blank">FlatIcon</a><br/>
                </p>
            </div>
        </div>
    </div>

    <!-- End Document
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>
